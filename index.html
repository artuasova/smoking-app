<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a2a6c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="–°—á–µ—Ç—á–∏–∫ —Å–∏–≥–∞—Ä–µ—Ç">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="HandheldFriendly" content="true">
    <title>SmokeLess</title>
    <meta name="description" content="SmokeLess - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Å–∏–≥–∞—Ä–µ—Ç">
    <link rel="manifest" href="manifest.json">
    <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö Web App Manifest -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
    <!-- Apple Touch Icon –¥–ª—è homescreen -->
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: white;
            --border-color: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --primary-btn: linear-gradient(to right, #4CAF50, #8BC34A);
            --secondary-btn: linear-gradient(to right, #f44336, #FF9800);
            --warning-btn: linear-gradient(to right, #FF9800, #FF5722);
            /* –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è progress-container */
            --progress-container-bg-start: rgba(255, 255, 255, 0.1);
            /* –ö–æ–Ω–µ—á–Ω—ã–π —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è progress-container –ø—Ä–∏ >100% */
            --progress-container-bg-end: rgba(255, 100, 100, 0.2);
        }
        /* data-theme="light" —É–¥–∞–ª–µ–Ω, —Ç–∞–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —É–±—Ä–∞–Ω */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }
        html {
            height: 100%;
        }
        body {
            background: var(--bg-gradient) !important;
            color: var(--text-color);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: manipulation;
            margin: 0;
            background-attachment: fixed !important;
            background-size: cover !important;
            background-repeat: no-repeat !important;
            background-position: center center !important;
        }
        /* –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–∫—Å –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è —Ñ–æ–Ω–∞ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-gradient);
            z-index: -1;
            background-attachment: fixed;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
        }
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px));
        }
        header {
            text-align: center;
            padding: 10px 0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-content {
            flex: 1;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        /* –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .settings-btn {
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-right: 8px; /* –î–æ–±–∞–≤–∏–º –æ—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ */
        }
        /* –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Ä–∞–Ω–µ–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã) */
        .stats-btn {
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .counter-card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .counter-value {
            font-size: 4.5rem;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        .counter-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
        }
        .btn {
            padding: 12px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            min-width: 120px;
            touch-action: manipulation;
        }
        .btn-primary {
            background: var(--primary-btn);
            color: white;
        }
        .btn-secondary {
            background: var(--secondary-btn);
            color: white;
        }
        .btn-warning {
            background: var(--warning-btn);
            color: white;
        }
        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.25);
        }
        .btn:active {
            transform: translateY(0.5px);
        }
        /* --- –ü–†–û–ì–†–ï–°–°-–ë–ê–† –ü–ï–†–ï–ú–ï–©–ï–ù –í–´–®–ï --- */
        .progress-container {
            background: var(--progress-container-bg-start);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            /* –ü–µ—Ä–µ—Ö–æ–¥ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ–Ω–∞ */
            transition: background-color 0.5s ease;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .progress-bar {
            height: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 8px;
            width: 0%;
            transition: width 0.5s ease, background-color 0.5s ease;
        }
        /* --- –ö–û–ù–ï–¶ –ü–†–û–ì–†–ï–°–°-–ë–ê–†–ê --- */
        .timer-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 18px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        .timer-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 8px 0;
            color: #4CAF50;
            text-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .stat-card {
            background: var(--card-bg);
            border-radius: 13px;
            padding: 13px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover {
            transform: translateY(-1px);
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 6px 0;
        }
        .stat-label {
            font-size: 0.95rem;
            opacity: 0.8;
        }
        .time-details {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            max-height: 180px;
            overflow-y: auto;
        }
        .time-item {
            padding: 4px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .time-item:last-child {
            border-bottom: none;
        }
        .costs-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 18px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        .costs-amount {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 10px 0;
            color: #FF6B6B;
            text-shadow: 0 0 8px rgba(255, 107, 107, 0.5);
        }
        .quote-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 18px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
            font-style: italic;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
        }
        .achievements-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }
        .achievement {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        .achievement.achieved {
            background: rgba(76, 175, 80, 0.2);
        }
        .achievement-icon {
            font-size: 1.3rem;
            margin-right: 12px;
        }
        .achievement-info {
            flex: 1;
        }
        .achievement-name {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 1rem;
        }
        .achievement-desc {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.4rem;
            cursor: pointer;
        }
        .setting {
            margin-bottom: 18px;
        }
        .setting label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: 1rem;
        }
        .setting input, .setting select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 0.95rem;
        }
        .setting input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 18px;
            align-items: center;
        }
        .btn-full {
            flex: 1;
            width: 100%;
            max-width: 300px;
        }
        .danger-btn {
            background: linear-gradient(to right, #f44336, #d32f2f);
            color: white;
        }
        /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°—Ç–∏–ª–∏ –¥–ª—è user-panel --- */
        .user-panel {
          background: var(--card-bg);
          border-radius: 13px;
          padding: calc(12px + env(safe-area-inset-top, 0px)) 12px 12px 12px;
          margin-bottom: 15px;
          display: none;
          box-sizing: border-box;
          width: 100%;
        }
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
        }
        /* --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø user-panel --- */
        .sync-indicator {
            position: fixed;
            top: 8px;
            right: 8px;
            padding: 6px 10px;
            border-radius: 18px;
            font-size: 0.75rem;
            z-index: 1000;
            display: none;
        }
        .sync-syncing {
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sync-success {
            background: #4CAF50;
            color: white;
        }
        .sync-error {
            background: #f44336;
            color: white;
        }
        footer {
            text-align: center;
            padding: 12px;
            margin-top: auto;
            opacity: 0.7;
            font-size: 0.75rem;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pulse {
            animation: pulse 0.4s;
        }
        @media (max-width: 600px) {
            body {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            }
            .counter-value {
                font-size: 3.8rem;
            }
            .counter-buttons {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            .btn {
                width: 100%;
                max-width: 280px;
                padding: 15px;
                font-size: 1.1rem;
            }
            .stats-container {
                grid-template-columns: 1fr;
            }
            .stat-card {
                padding: 12px;
            }
            .stat-value {
                font-size: 2rem;
            }
            h1 {
                font-size: 1.6rem;
            }
            .subtitle {
                font-size: 0.85rem;
            }
            .header-content {
                text-align: center;
            }
            .settings-btn, .stats-btn {
                position: static;
                margin: 4px;
            }
        }
        @media (max-width: 400px) {
            .counter-value {
                font-size: 3.2rem;
            }
            .costs-amount {
                font-size: 1.8rem;
            }
            /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ–Ω–∞ */
            html, body {
                height: 100%;
                height: -webkit-fill-available;
                margin: 0;
                padding: 0;
                background: var(--bg-gradient) !important;
                background-attachment: fixed !important;
                background-size: cover !important;
                background-repeat: no-repeat !important;
            }
            /* –§–∏–∫—Å –¥–ª—è PWA */
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                overscroll-behavior: none;
            }
            /* –§–æ–Ω –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            .container {
                max-width: 800px;
                width: 100%;
                margin: 0 auto;
                position: relative;
                padding: 10px;
                display: flex;
                flex-direction: column;
            }
            /* –§–∏–∫—Å –¥–ª—è overscroll */
            body::-webkit-scrollbar {
                display: none;
            }
            body {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            /* –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞ */
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--bg-gradient);
                z-index: -1;
                background-attachment: fixed;
            }
            /* –§–∏–∫—Å –¥–ª—è pull-to-refresh */
            body {
                background: var(--bg-gradient) !important;
                background-attachment: fixed !important;
                overscroll-behavior: contain;
                -webkit-overscroll-behavior: contain;
            }
            /* –£–ª—É—á—à–µ–Ω–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            :root {
                --bg-gradient: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c) !important;
            }
            /* –§–∏–∫—Å –¥–ª—è iOS PWA */
            @supports (-webkit-touch-callout: none) {
                .container {
                    min-height: -webkit-fill-available;
                }
                body {
                    min-height: -webkit-fill-available;
                }
            }
            /* –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ –≤ –∫–æ–Ω–µ—Ü CSS —Å–µ–∫—Ü–∏–∏ */
            .scroll-container {
                height: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }
        }
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ */
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c) !important;
            background-attachment: fixed;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞ */
        @keyframes appLogoPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.85; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes appSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ */
        @keyframes pulseDanger {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.7; transform: scale(1.01); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ --- */
        .stats-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .stats-modal-content {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            max-height: 90vh;
            overflow-y: auto;
            text-align: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
        }
        .stats-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .stats-modal-header h2 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }
        /* --- –ö–æ–Ω–µ—Ü —Å—Ç–∏–ª–µ–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ --- */
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ --- */
        .chart-selector {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .chart-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 6px 12px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        .chart-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .chart-btn.active {
            background: var(--primary-btn);
            border-color: transparent;
            font-weight: bold;
        }
        /* --- –ö–æ–Ω–µ—Ü —Å—Ç–∏–ª–µ–π –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ --- */
    </style>
</head>
<body>
    <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ (Preloader) -->
    <div id="app-preloader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.4s ease-out;">
        <img src="icon-192x192.png" alt="SmokeLess Logo" style="width: 90px; height: 90px; margin-bottom: 18px; animation: appLogoPulse 1.8s infinite;">
        <div style="color: white; font-size: 1.3rem; font-weight: bold; text-align: center; padding: 0 15px;">SmokeLess –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
        <!-- –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ -->
        <div style="margin-top: 25px; width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid white; border-radius: 50%; animation: appSpin 0.9s linear infinite;"></div>
    </div>
    <div class="container">
        <div class="sync-indicator" id="syncIndicator">
            <span id="syncText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
        </div>
        <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª–µ–Ω HTML user-panel –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="user-panel" id="userPanel">
            <div class="user-info">
                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –ê–≤–∞—Ç–∞—Ä –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                        <div style="font-size: 0.75rem; opacity: 0.8;" id="userEmail">email@example.com</div>
                    </div>
                </div>
                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
                    <div id="syncStatusIndicator" style="font-size: 1.1rem; display: none;">‚ö™</div>
                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ -->
                    <div id="syncStatusText" style="font-size: 0.8rem; display: none;"></div>
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                    <button id="refreshAppBtnTop" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" style="background: none; border: none; cursor: pointer; font-size: 1.1rem;">üîÑ</button>
                </div>
            </div>
        </div>
        <!-- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø user-panel -->
        <header>
            <div class="header-content">
                <h1>–°—á–µ—Ç—á–∏–∫ —Å–∏–≥–∞—Ä–µ—Ç</h1>
                <p class="subtitle">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∏ —Ä–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ —É–ª—É—á—à–µ–Ω–∏–µ–º –∑–¥–æ—Ä–æ–≤—å—è</p>
            </div>
            <button class="settings-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
            <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–µ–º—ã -->
            <button class="stats-btn" id="statsBtn" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">üìä</button>
        </header>
        <div class="scroll-container">
        <main>
            <div class="counter-card">
                <h2>–°–µ–≥–æ–¥–Ω—è –≤—ã–∫—É—Ä–µ–Ω–Ω—ã—Ö —Å–∏–≥–∞—Ä–µ—Ç</h2>
                <div class="counter-value" id="counter">0</div>
                <div class="counter-buttons">
                    <button class="btn btn-primary" id="increment">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn btn-secondary" id="decrement">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                 <button id="manualResetToday" style="background: none; border: none; color: #ff4081; cursor: pointer; font-size: 0.85rem; margin-top: 12px; text-align: center; width: 100%;">–ù–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å</button>
            </div>
            <!-- –ü–†–û–ì–†–ï–°–°-–ë–ê–† –ü–ï–†–ï–ú–ï–©–ï–ù –°–Æ–î–ê -->
            <div class="progress-container">
                <div class="progress-header">
                    <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–∫–∞–∑–∞ –æ—Ç –∫—É—Ä–µ–Ω–∏—è üòä</h3> <!-- –ù–∞—á–∞–ª—å–Ω—ã–π —ç–º–æ–¥–∑–∏ -->
                    <span id="goal-percent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p style="margin-top: 10px; font-size: 0.9rem;">–¶–µ–ª—å: <span id="goal">20</span> —Å–∏–≥–∞—Ä–µ—Ç –≤ –¥–µ–Ω—å</p>
            </div>
            <!-- –ö–û–ù–ï–¶ –ü–†–û–ì–†–ï–°–°-–ë–ê–†–ê -->
            <div class="timer-container">
                <h3>–í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã</h3>
                <div class="timer-value" id="timer">00:00:00</div>
                <p style="font-size: 0.9rem;">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–≥–∞—Ä–µ—Ç–∞: <span id="last-cigarette-time">--:--:--</span></p>
                <div class="medical-fact-container" style="margin-top: 12px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; display: none; font-size: 0.85rem;" id="medical-fact">
                    <!-- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ñ–∞–∫—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —Å—é–¥–∞ -->
                </div>
            </div>
            <div class="stats-container">
                <div class="stat-card" id="weekCard">
                    <div class="stat-value" id="week">0</div>
                    <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                </div>
                <div class="stat-card" id="monthCard">
                    <div class="stat-value" id="month">0</div>
                    <div class="stat-label">–ó–∞ –º–µ—Å—è—Ü</div>
                </div>
                <div class="stat-card" id="allTimeCard" style="cursor: pointer; text-align: center;">
                    <div class="stat-value" id="allTimeValue">0</div>
                    <div class="stat-label">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
                    <div class="stat-sublabel" id="firstUseDateLabel" style="font-size: 0.65rem; opacity: 0.7; margin-top: 4px;">--.--.----</div>
                </div>
            </div>
            <div class="costs-container">
                <h3>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ —Å–∏–≥–∞—Ä–µ—Ç—ã</h3>
                <div class="costs-amount" id="costs">0 ‚ÇΩ</div>
                <p style="font-size: 0.9rem;">–ü—Ä–∏ —Ü–µ–Ω–µ –ø–∞—á–∫–∏ <span id="pack-price">250</span> ‚ÇΩ</p>
            </div>
            <div class="quote-container">
                <p id="quote">"–ö–∞–∂–¥–∞—è –Ω–µ –≤—ã–∫—É—Ä–µ–Ω–Ω–∞—è —Å–∏–≥–∞—Ä–µ—Ç–∞ - —à–∞–≥ –∫ –∑–¥–æ—Ä–æ–≤—å—é!"</p>
            </div>
            <div class="achievements-container">
                <div class="achievements-header">
                    <h3>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                    <span id="achievements-count">0/0</span>
                </div>
                <div id="achievements-list">
                    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
                </div>
            </div>
        </main>
        </div>
        <footer>
            <p>SmokeLess - Smoking Tracker App by Artuasova | ¬© 2025 Ver.0.8</p>
        </footer>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authTitle">–í—Ö–æ–¥</h2>
                <button class="close-modal" id="closeAuthModal">&times;</button>
            </div>
            <div class="setting">
                <label>Email:</label>
                <input type="email" id="authEmail" placeholder="example@email.com">
            </div>
            <div class="setting">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="authPassword" placeholder="********">
            </div>
            <div class="setting" id="forgotPasswordSection" style="display: none;">
                <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                <input type="password" id="newPassword" placeholder="********">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary btn-full" id="authSubmit">–í–æ–π—Ç–∏</button>
                <button class="btn btn-secondary btn-full" id="toggleAuth">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button class="btn btn-warning btn-full" id="forgotPasswordBtn">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
                <button class="btn btn-secondary btn-full" id="resetPasswordBtn" style="display: none;">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </div>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="setting">
                <label>–¶–µ–ª—å (—Å–∏–≥–∞—Ä–µ—Ç –≤ –¥–µ–Ω—å):</label>
                <input type="number" id="goalSetting" value="20" min="0">
            </div>
            <div class="setting">
                <label>–¶–µ–Ω–∞ –ø–∞—á–∫–∏ (‚ÇΩ):</label>
                <input type="number" id="priceSetting" value="250" min="0">
            </div>
            <div class="setting">
                <label>–°–∏–≥–∞—Ä–µ—Ç –≤ –ø–∞—á–∫–µ:</label>
                <input type="number" id="countSetting" value="20" min="1">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary btn-full" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                <button class="btn danger-btn btn-full" id="resetAllBtn">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
                <button class="btn btn-warning btn-full" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
                <button class="btn btn-primary btn-full" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="logoutFromSettings" style="background: none; border: none; color: #ff4081; cursor: pointer; font-size: 0.85rem; margin-top: 12px; text-align: center; width: 100%;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            </div>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="stats-modal" id="statsModal">
        <div class="stats-modal-content">
            <div class="stats-modal-header">
                <h2>üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <button class="close-modal" id="closeStatsModal">&times;</button>
            </div>
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
            <div class="chart-selector">
                <button class="chart-btn active" data-chart="weekday">–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</button>
                <button class="chart-btn" data-chart="daily">–ü–æ –¥–Ω—è–º</button>
                <button class="chart-btn" data-chart="hourly">–ü–æ —á–∞—Å–∞–º</button>
                <button class="chart-btn" data-chart="savings">–≠–∫–æ–Ω–æ–º–∏—è</button>
            </div>

            <div style="position: relative; height: 250px; margin-bottom: 15px;">
                <canvas id="statsChart" style="width: 100%; height: 100%;"></canvas>
            </div>
            <!-- –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π -->
            <div id="chart-axis-labels" style="display: flex; justify-content: space-between; font-size: 0.7rem; opacity: 0.8; margin-top: 5px;">
                <span id="y-axis-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span id="x-axis-label">–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</span>
            </div>
        </div>
    </div>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
        const supabaseUrl = 'https://podwpmokbbyzkrqhygci.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZHdwbW9rYmJ5emtycWh5Z2NpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzI1MzQsImV4cCI6MjA2ODk0ODUzNH0.3UH4jmnzgPub0GLCK4yXE692kpYuXVt9LAwJmC5heaA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let data = {
            today: 0,
            week: 0,
            month: 0,
            goal: 20,
            packPrice: 250,
            cigarettesPerPack: 20,
            streak: 0,
            lastDate: null,
            timeStats: [],
            lastAutoResetDate: new Date().toDateString(), // –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞
            achievements: [
                { id: 1, name: "–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å", description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å", target: 1, achieved: false, icon: "üìÖ" },
                { id: 2, name: "–ù–µ–¥–µ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—é", target: 7, achieved: false, icon: "üóìÔ∏è" },
                { id: 3, name: "–ú–µ—Å—è—Ü –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–µ—Å—è—Ü", target: 30, achieved: false, icon: "üìÜ" },
                { id: 4, name: "100 —Å–∏–≥–∞—Ä–µ—Ç", description: "–í—ã–∫—É—Ä–∏—Ç—å 100 —Å–∏–≥–∞—Ä–µ—Ç", target: 100, achieved: false, icon: "üö¨" },
                { id: 5, name: "–≠–∫–æ–Ω–æ–º–∏—è –∑–¥–æ—Ä–æ–≤—å—è", description: "–°–æ–∫—Ä–∞—Ç–∏—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –Ω–∞ 50% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –Ω–µ–¥–µ–ª–µ–π", target: 50, achieved: false, icon: "üíö" }
            ],
            totalCost: 0,
            usageDays: 0,
            firstUseDate: new Date().toDateString(),
            lastCigaretteTime: null
        };
        // –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã
        const quotes = [
            "–ö–∞–∂–¥–∞—è –Ω–µ –≤—ã–∫—É—Ä–µ–Ω–Ω–∞—è —Å–∏–≥–∞—Ä–µ—Ç–∞ - —à–∞–≥ –∫ –∑–¥–æ—Ä–æ–≤—å—é!",
            "–í—ã —Å–∏–ª—å–Ω–µ–µ —Å–≤–æ–µ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏!",
            "–≠–∫–æ–Ω–æ–º–∏—è —Å–µ–≥–æ–¥–Ω—è - –∑–¥–æ—Ä–æ–≤—å–µ –∑–∞–≤—Ç—Ä–∞!",
            "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç –¥–µ–ª–∞–µ—Ç –≤–∞—Å —Å–∏–ª—å–Ω–µ–µ!",
            "–í–∞—à–µ –∑–¥–æ—Ä–æ–≤—å–µ - –≤–∞—à–∞ —Ü–µ–Ω–Ω–æ—Å—Ç—å!",
            "–°–∏–ª–∞ –≤–æ–ª–∏ - –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É!",
            "–ö–∞–∂–¥–∞—è —Å–∏–≥–∞—Ä–µ—Ç–∞, –∫–æ—Ç–æ—Ä—É—é –≤—ã –Ω–µ –≤—ã–∫—É—Ä–∏–ª–∏ - –ø–æ–±–µ–¥–∞!",
            "–ó–¥–æ—Ä–æ–≤—å–µ –Ω–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å, –Ω–æ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å!",
            "–°–µ–≥–æ–¥–Ω—è –≤—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –≤—á–µ—Ä–∞!",
            "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å - —ç—Ç–æ –Ω–æ–≤—ã–π —à–∞–Ω—Å!"
        ];
        // –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã –ø–æ —á–∞—Å–∞–º (–æ—Ç 1 –¥–æ 24 —á–∞—Å–∞)
        const medicalFacts = [
            "–ß–µ—Ä–µ–∑ 1 —á–∞—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã –ø—É–ª—å—Å –∏ –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞—é—Ç —Å–Ω–∏–∂–∞—Ç—å—Å—è –¥–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è.",
            "–ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–µ—Ä–∏—Ñ–µ—Ä–∏—á–µ—Å–∫–∏–µ –∫—Ä–æ–≤–µ–Ω–æ—Å–Ω—ã–µ —Å–æ—Å—É–¥—ã —Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è, —É–ª—É—á—à–∞–µ—Ç—Å—è —Ü–∏—Ä–∫—É–ª—è—Ü–∏—è –∫—Ä–æ–≤–∏ –≤ —Ä—É–∫–∞—Ö –∏ –Ω–æ–≥–∞—Ö.",
            "–ß–µ—Ä–µ–∑ 3 —á–∞—Å–∞ —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∫–æ—Ç–∏–Ω–∞ –≤ –∫—Ä–æ–≤–∏ —Å–Ω–∏–∂–∞–µ—Ç—Å—è –¥–æ –Ω—É–ª—è, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –¥–µ—Ç–æ–∫—Å–∏–∫–∞—Ü–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–º–∞.",
            "–ß–µ—Ä–µ–∑ 4 —á–∞—Å–∞ —É–ª—É—á—à–∞–µ—Ç—Å—è –Ω–∞—Å—ã—â–µ–Ω–∏–µ –∫—Ä–æ–≤–∏ –∫–∏—Å–ª–æ—Ä–æ–¥–æ–º, —Å–Ω–∏–∂–∞–µ—Ç—Å—è —Ä–∏—Å–∫ —Å–µ—Ä–¥–µ—á–Ω–æ–≥–æ –ø—Ä–∏—Å—Ç—É–ø–∞.",
            "–ß–µ—Ä–µ–∑ 5 —á–∞—Å–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–∏–∑–∏—Å—Ç–æ–π –æ–±–æ–ª–æ—á–∫–∏ –Ω–æ—Å–æ–≥–ª–æ—Ç–∫–∏ –∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π.",
            "–ß–µ—Ä–µ–∑ 6 —á–∞—Å–æ–≤ —É–ª—É—á—à–∞–µ—Ç—Å—è –≤–∫—É—Å –∏ –æ–±–æ–Ω—è–Ω–∏–µ, –æ—Ä–≥–∞–Ω–∏–∑–º –Ω–∞—á–∏–Ω–∞–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å —Ç–æ–∫—Å–∏–Ω—ã.",
            "–ß–µ—Ä–µ–∑ 7 —á–∞—Å–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Ç–µ–ª–∞, —É–ª—É—á—à–∞–µ—Ç—Å—è –∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏–µ.",
            "–ß–µ—Ä–µ–∑ 8 —á–∞—Å–æ–≤ —É—Ä–æ–≤–µ–Ω—å –æ–∫—Å–∏–¥–∞ —É–≥–ª–µ—Ä–æ–¥–∞ –≤ –∫—Ä–æ–≤–∏ —Å–Ω–∏–∂–∞–µ—Ç—Å—è, –∫–∏—Å–ª–æ—Ä–æ–¥–Ω–æ–µ –Ω–∞—Å—ã—â–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è.",
            "–ß–µ—Ä–µ–∑ 9 —á–∞—Å–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ª–µ–≥–∫–∏—Ö, —É–ª—É—á—à–∞–µ—Ç—Å—è –¥—ã—Ö–∞–Ω–∏–µ.",
            "–ß–µ—Ä–µ–∑ 10 —á–∞—Å–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞, —É–ª—É—á—à–∞–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.",
            "–ß–µ—Ä–µ–∑ 11 —á–∞—Å–æ–≤ —É–ª—É—á—à–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ –ø–∏—â–µ–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, —Å–Ω–∏–∂–∞–µ—Ç—Å—è —Ç–æ—à–Ω–æ—Ç–∞.",
            "–ß–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–º—É–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –æ—Ä–≥–∞–Ω–∏–∑–º –±–æ—Ä–µ—Ç—Å—è —Å –∏–Ω—Ñ–µ–∫—Ü–∏—è–º–∏.",
            "–ß–µ—Ä–µ–∑ 13 —á–∞—Å–æ–≤ —É–ª—É—á—à–∞–µ—Ç—Å—è –∫—Ä–æ–≤–æ—Ç–æ–∫ –≤ –º–æ–∑–≥–µ, –ø–æ–≤—ã—à–∞–µ—Ç—Å—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≤–Ω–∏–º–∞–Ω–∏—è.",
            "–ß–µ—Ä–µ–∑ 14 —á–∞—Å–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç—Å—è —Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —É–ª—É—á—à–∞–µ—Ç—Å—è –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞.",
            "–ß–µ—Ä–µ–∑ 15 —á–∞—Å–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–µ—Ç–æ–∫ –ø–µ—á–µ–Ω–∏, —É–ª—É—á—à–∞–µ—Ç—Å—è –º–µ—Ç–∞–±–æ–ª–∏–∑–º.",
            "–ß–µ—Ä–µ–∑ 16 —á–∞—Å–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å –∫–∞—à–ª—è, —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –æ–¥—ã—à–∫–∞.",
            "–ß–µ—Ä–µ–∑ 17 —á–∞—Å–æ–≤ —É–ª—É—á—à–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —Å–µ—Ä–¥—Ü–∞, —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –æ—Ä–≥–∞–Ω.",
            "–ß–µ—Ä–µ–∑ 18 —á–∞—Å–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∫—É—Å–æ–≤—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ—Ä–æ–≤, –µ–¥–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∫—É—Å–Ω–µ–µ.",
            "–ß–µ—Ä–µ–∑ 19 —á–∞—Å–æ–≤ —É–ª—É—á—à–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ –ø–æ—á–µ–∫, –æ—Ä–≥–∞–Ω–∏–∑–º –ª—É—á—à–µ –≤—ã–≤–æ–¥–∏—Ç —Ç–æ–∫—Å–∏–Ω—ã.",
            "–ß–µ—Ä–µ–∑ 20 —á–∞—Å–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç—Å—è —Ä–∏—Å–∫ –∏–Ω—Å—É–ª—å—Ç–∞, —É–ª—É—á—à–∞–µ—Ç—Å—è –∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –º–æ–∑–≥–µ.",
            "–ß–µ—Ä–µ–∑ 21 —á–∞—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, —É–ª—É—á—à–∞–µ—Ç—Å—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è.",
            "–ß–µ—Ä–µ–∑ 22 —á–∞—Å–∞ —É–ª—É—á—à–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —ç–Ω–¥–æ–∫—Ä–∏–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –≥–æ—Ä–º–æ–Ω—ã.",
            "–ß–µ—Ä–µ–∑ 23 —á–∞—Å–∞ —Å–Ω–∏–∂–∞–µ—Ç—Å—è –≤–æ—Å–ø–∞–ª–µ–Ω–∏–µ –≤ –æ—Ä–≥–∞–Ω–∏–∑–º–µ, —É–ª—É—á—à–∞–µ—Ç—Å—è –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.",
            "–ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –æ—Ä–≥–∞–Ω–∏–∑–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–±–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç –Ω–∏–∫–æ—Ç–∏–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ."
        ];
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const counterEl = document.getElementById('counter');
        const weekEl = document.getElementById('week');
        const monthEl = document.getElementById('month');
        const goalEl = document.getElementById('goal');
        const goalPercentEl = document.getElementById('goal-percent');
        const progressFillEl = document.getElementById('progress-fill');
        const costsEl = document.getElementById('costs');
        const packPriceEl = document.getElementById('pack-price');
        const quoteEl = document.getElementById('quote');
        const achievementsListEl = document.getElementById('achievements-list');
        const achievementsCountEl = document.getElementById('achievements-count');
        const timerEl = document.getElementById('timer');
        const lastCigaretteTimeEl = document.getElementById('last-cigarette-time');
        const syncIndicator = document.getElementById('syncIndicator');
        const syncText = document.getElementById('syncText');
        const userPanel = document.getElementById('userPanel');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const logoutFromSettingsBtn = document.getElementById('logoutFromSettings');
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ –ø–∞–Ω–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const refreshAppBtnTop = document.getElementById('refreshAppBtnTop');
        const syncStatusIndicator = document.getElementById('syncStatusIndicator');
        const syncStatusText = document.getElementById('syncStatusText');
        // Auth elements
        const authModal = document.getElementById('authModal');
        const authTitle = document.getElementById('authTitle');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const newPassword = document.getElementById('newPassword');
        const authSubmit = document.getElementById('authSubmit');
        const toggleAuth = document.getElementById('toggleAuth');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        const forgotPasswordSection = document.getElementById('forgotPasswordSection');
        const closeAuthModal = document.getElementById('closeAuthModal');
        // Settings elements
        const settingsModal = document.getElementById('settingsModal');
        const settingsBtn = document.getElementById('settingsBtn');
        // –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Ä–∞–Ω–µ–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã)
        const statsBtn = document.getElementById('statsBtn');
        const incrementBtn = document.getElementById('increment');
        const decrementBtn = document.getElementById('decrement');
        const saveSettingsBtn = document.getElementById('saveSettings');
        const exportBtn = document.getElementById('exportBtn');
        const resetAllBtn = document.getElementById('resetAllBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const manualResetTodayBtn = document.getElementById('manualResetToday');
        // --- –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
        const statsModal = document.getElementById('statsModal');
        const closeStatsModal = document.getElementById('closeStatsModal');
        const statsChartCanvas = document.getElementById('statsChart');
        const chartSelector = document.querySelector('.chart-selector');
        const xAxisLabel = document.getElementById('x-axis-label');
        const yAxisLabel = document.getElementById('y-axis-label');
        // --- –ö–æ–Ω–µ—Ü —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
        // Auth state
        let isRegistration = false;
        let isForgotPassword = false;
        let currentUser = null;
        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –°–ë–†–û–°–ê ---
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–±—Ä–æ—Å–∞ (06:00 –∑–∞–≤—Ç—Ä–∞)
        function getNextResetTime() {
            const now = new Date();
            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –Ω–∞ 06:00 —Å–µ–≥–æ–¥–Ω—è
            const nextReset = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6, 0, 0, 0);
            // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å —É–∂–µ –ø—Ä–æ—à–ª–æ 06:00 —Å–µ–≥–æ–¥–Ω—è, —Ç–æ —Å–ª–µ–¥—É—é—â–∏–π —Å–±—Ä–æ—Å - –∑–∞–≤—Ç—Ä–∞ –≤ 06:00
            if (now >= nextReset) {
                nextReset.setDate(nextReset.getDate() + 1);
            }
            return nextReset;
        }
        // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–ê)
        function performAutoReset() {
            console.log("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å...");
            data.today = 0;
            // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ "—Å–µ–≥–æ–¥–Ω—è" (—Å 06:00 —Å–µ–≥–æ–¥–Ω—è –¥–æ 05:59 –∑–∞–≤—Ç—Ä–∞)
            const now = new Date();
            const startOfTodayPeriod = new Date(now);
            startOfTodayPeriod.setHours(6, 0, 0, 0); // –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞
            const endOfTodayPeriod = new Date(startOfTodayPeriod);
            endOfTodayPeriod.setDate(endOfTodayPeriod.getDate() + 1); // –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ (—Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å)
            endOfTodayPeriod.setMilliseconds(endOfTodayPeriod.getMilliseconds() - 1); // –ú–∏–Ω—É—Å 1 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞
            // 2. –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑ data.timeStats, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥
            const initialStatsCount = data.timeStats.length;
            data.timeStats = data.timeStats.filter(stat => {
                const statTimestamp = stat.timestamp;
                // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –≤—Ö–æ–¥—è—Ç –≤ –ø–µ—Ä–∏–æ–¥ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
                return !(statTimestamp >= startOfTodayPeriod.getTime() && statTimestamp <= endOfTodayPeriod.getTime());
            });
            const removedStatsCount = initialStatsCount - data.timeStats.length;
            console.log(`–£–¥–∞–ª–µ–Ω–æ ${removedStatsCount} –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è.`);
            // 3. –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã (lastCigaretteTime)
            // –≠—Ç–æ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã —Ç–∞–π–º–µ—Ä –∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
            if (data.timeStats.length > 0) {
                // –ë–µ—Ä–µ–º —Å–∞–º—É—é –ø–æ—Å–ª–µ–¥–Ω—é—é (–Ω–æ–≤—É—é) –∑–∞–ø–∏—Å—å –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
                const lastRecord = data.timeStats[data.timeStats.length - 1];
                data.lastCigaretteTime = lastRecord.timestamp;
                console.log("–ù–æ–≤–æ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã:", new Date(data.lastCigaretteTime).toLocaleString('ru-RU'));
            } else {
                // –ï—Å–ª–∏ —Å–∏–≥–∞—Ä–µ—Ç –±–æ–ª—å—à–µ –Ω–µ—Ç –≤–æ–æ–±—â–µ
                data.lastCigaretteTime = null;
                console.log("–í—Å–µ —Å–∏–≥–∞—Ä–µ—Ç—ã —É–¥–∞–ª–µ–Ω—ã, –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã —Å–±—Ä–æ—à–µ–Ω–æ.");
            }
            // 4. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞
            // –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª —Å–Ω–æ–≤–∞ –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å
            data.lastAutoResetDate = new Date().toDateString();
            console.log("–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞:", data.lastAutoResetDate);
            // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            saveData();
            updateUI();
            console.log("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω.");
        }
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–±—Ä–æ—Å–∞
        function checkForAutoReset() {
            const todayString = new Date().toDateString();
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ —Å–±—Ä–æ—Å —Å–µ–≥–æ–¥–Ω—è
            if (data.lastAutoResetDate !== todayString) {
                const now = new Date();
                const nextResetTime = getNextResetTime();
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª–æ –ª–∏ –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ (06:00)
                if (now >= nextResetTime || data.lastAutoResetDate === null) {
                     performAutoReset();
                }
            }
        }
        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –õ–û–ì–ò–ö–ò ---
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            loadData();
            updateUI();
            showRandomQuote();
            renderAchievements();
            checkAchievements();
            startTimer();
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            incrementBtn.addEventListener('click', incrementCounter);
            decrementBtn.addEventListener('click', decrementCounter);
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            settingsBtn.addEventListener('click', openSettings);
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            statsBtn.addEventListener('click', openStatsModal);
            saveSettingsBtn.addEventListener('click', saveSettings);
            exportBtn.addEventListener('click', exportData);
            resetAllBtn.addEventListener('click', resetAll);
            refreshBtn.addEventListener('click', refreshApp);
            logoutFromSettingsBtn.addEventListener('click', logout);
            refreshAppBtnTop.addEventListener('click', refreshApp);
            document.querySelector('#settingsModal .close-modal').addEventListener('click', closeSettings);
            manualResetTodayBtn.addEventListener('click', manualResetToday);
            // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
            closeStatsModal.addEventListener('click', closeStatsModalFunc);
            statsModal.addEventListener('click', function(e) {
                if (e.target === this) closeStatsModalFunc();
            });
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
            chartSelector.addEventListener('click', function(e) {
                if (e.target.classList.contains('chart-btn')) {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
                    e.target.classList.add('active');
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
                    const chartType = e.target.getAttribute('data-chart');
                    // –†–∏—Å—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
                    renderStatsChart(chartType);
                }
            });
            // --- –ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
            // Auth handlers
            document.getElementById('authSubmit').addEventListener('click', handleAuth);
            document.getElementById('toggleAuth').addEventListener('click', toggleAuthForm);
            document.getElementById('forgotPasswordBtn').addEventListener('click', toggleForgotPassword);
            document.getElementById('resetPasswordBtn').addEventListener('click', resetPassword);
            document.getElementById('closeAuthModal').addEventListener('click', hideAuthModal);
            document.getElementById('authModal').addEventListener('click', function(e) {
                if (e.target === this) hideAuthModal();
            });
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            document.getElementById('weekCard').addEventListener('click', function() {
                toggleTimeDetails('week');
            });
            document.getElementById('monthCard').addEventListener('click', function() {
                toggleTimeDetails('month');
            });
            // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ monthCard.addEventListener(...)
            document.getElementById('allTimeCard').addEventListener('click', function() {
                toggleTimeDetails('all');
            });
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
            checkSession();
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
                });
            }
            // –ó–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
            setInterval(checkForAutoReset, 60 * 1000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
            checkForAutoReset();
            // –°–∫—Ä—ã—Ç—å –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            hidePreloader();
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞
        function hidePreloader() {
            const preloader = document.getElementById('app-preloader');
            if (preloader) {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
                preloader.style.opacity = '0';
                // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
                setTimeout(() => {
                    if (preloader.parentNode) {
                        preloader.parentNode.removeChild(preloader);
                    }
                }, 400); // –î–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é transition –≤ CSS (0.4s)
            }
        }
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
        async function checkSession() {
            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ê –°–ò–ù–¢–ê–ö–°–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê ---
            const { data: { session } } = await supabase.auth.getSession();
            // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
            if (session) {
                currentUser = session.user;
                showUserPanel();
                await loadUserData();
            } else {
                showAuthModal();
            }
        }
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function showUserPanel() {
            if (currentUser) {
                const email = currentUser.email;
                userAvatar.textContent = email.charAt(0).toUpperCase();
                userName.textContent = email.split('@')[0];
                userEmail.textContent = email;
                userPanel.style.display = 'block';
            }
        }
        // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function hideUserPanel() {
            userPanel.style.display = 'none';
        }
        // –í—ã—Ö–æ–¥
        async function logout() {
            const confirmed = confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?');
            if (confirmed) {
                await supabase.auth.signOut();
                currentUser = null;
                hideUserPanel();
                showAuthModal();
                showSyncIndicator('success', '–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
            }
        }
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function showAuthModal() {
            authTitle.textContent = '–í—Ö–æ–¥';
            authSubmit.textContent = '–í–æ–π—Ç–∏';
            toggleAuth.textContent = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            forgotPasswordSection.style.display = 'none';
            resetPasswordBtn.style.display = 'none';
            forgotPasswordBtn.style.display = 'block';
            isRegistration = false;
            isForgotPassword = false;
            authModal.style.display = 'flex';
        }
        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function hideAuthModal() {
            authModal.style.display = 'none';
        }
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function toggleAuthForm() {
            isRegistration = !isRegistration;
            if (isRegistration) {
                authTitle.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
                authSubmit.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                toggleAuth.textContent = '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏';
                forgotPasswordSection.style.display = 'none';
                resetPasswordBtn.style.display = 'none';
                forgotPasswordBtn.style.display = 'block';
            } else {
                authTitle.textContent = '–í—Ö–æ–¥';
                authSubmit.textContent = '–í–æ–π—Ç–∏';
                toggleAuth.textContent = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                forgotPasswordSection.style.display = 'none';
                resetPasswordBtn.style.display = 'none';
                forgotPasswordBtn.style.display = 'block';
            }
            isForgotPassword = false;
        }
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
        function toggleForgotPassword() {
            isForgotPassword = !isForgotPassword;
            if (isForgotPassword) {
                authTitle.textContent = '–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?';
                authSubmit.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É';
                forgotPasswordSection.style.display = 'block';
                resetPasswordBtn.style.display = 'block';
                forgotPasswordBtn.style.display = 'none';
                toggleAuth.style.display = 'none';
            } else {
                authTitle.textContent = '–í—Ö–æ–¥';
                authSubmit.textContent = '–í–æ–π—Ç–∏';
                forgotPasswordSection.style.display = 'none';
                resetPasswordBtn.style.display = 'none';
                forgotPasswordBtn.style.display = 'block';
                toggleAuth.style.display = 'block';
            }
        }
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        async function handleAuth() {
            const email = authEmail.value.trim();
            const password = authPassword.value;
            if (!email || !password) {
                showSyncIndicator('error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            try {
                let result;
                if (isRegistration) {
                    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    result = await supabase.auth.signUp({
                        email: email,
                        password: password
                    });
                    if (result.error) throw result.error;
                    showSyncIndicator('success', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                    hideAuthModal();
                    currentUser = result.data.user;
                    showUserPanel();
                    await saveUserData();
                } else if (isForgotPassword) {
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
                    const { error } = await supabase.auth.resetPasswordForEmail(email);
                    if (error) throw error;
                    showSyncIndicator('success', '–°—Å—ã–ª–∫–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
                } else {
                    // –í—Ö–æ–¥
                    result = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    if (result.error) throw result.error;
                    currentUser = result.data.user;
                    hideAuthModal();
                    showUserPanel();
                    showSyncIndicator('success', '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                    await loadUserData();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
                showSyncIndicator('error', '–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        // –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è
        async function resetPassword() {
            const email = authEmail.value.trim();
            const newPasswordVal = newPassword.value;
            if (!email || !newPasswordVal) {
                showSyncIndicator('error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPasswordVal
                });
                if (error) throw error;
                showSyncIndicator('success', '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω');
                toggleForgotPassword();
            } catch (error) {
                showSyncIndicator('error', '–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            if (!currentUser) return;
            try {
                showSyncIndicator('syncing', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ...');
                const { data: userData, error } = await supabase
                    .from('smoking_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                if (error && error.code !== 'PGRST116') { // PGRST116 –æ–∑–Ω–∞—á–∞–µ—Ç "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
                    throw error;
                }
                if (userData) {
                    // --- –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç data ---
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç, –æ–±—ä–µ–¥–∏–Ω—è—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    const newData = { ...data, ...userData.data };
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ timeStats –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (userData.data && Array.isArray(userData.data.timeStats)) {
                        // –ï—Å–ª–∏ timeStats –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                        newData.timeStats = userData.data.timeStats;
                    } else {
                        // –ï—Å–ª–∏ timeStats –Ω–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ (–∏–∑ localStorage –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ)
                        newData.timeStats = data.timeStats;
                    }
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ firstUseDate –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (userData.data && userData.data.firstUseDate) {
                        // –ï—Å–ª–∏ firstUseDate –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                        newData.firstUseDate = userData.data.firstUseDate;
                    } else {
                        // –ï—Å–ª–∏ firstUseDate –Ω–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É (–µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)
                        newData.firstUseDate = data.firstUseDate;
                    }
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ achievements –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (userData.data && Array.isArray(userData.data.achievements)) {
                        // –ï—Å–ª–∏ achievements –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                        newData.achievements = userData.data.achievements;
                    } else {
                        // –ï—Å–ª–∏ achievements –Ω–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ (–∏–∑ localStorage –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ)
                        newData.achievements = data.achievements;
                    }
                    data = newData;
                    console.log("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞:", data);
                    showSyncIndicator('success', '–û–±–Ω–æ–≤–ª–µ–Ω–æ');
                } else {
                    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ (–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∏–ª–∏ –∏–∑ localStorage)
                    await saveUserData();
                    showSyncIndicator('success', '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                }
                // --- –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º UI –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ ---
                updateUI();
                checkAchievements(); // <-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                renderAchievements(); // <-- –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showSyncIndicator('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–±–Ω–æ–≤–ª—è–µ–º UI —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å
                updateUI();
                checkAchievements();
                renderAchievements();
            }
        }
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function saveUserData() {
            if (!currentUser) return;
            try {
                const now = new Date().toISOString();
                const { error } = await supabase
                    .from('smoking_data')
                    .upsert({
                        user_id: currentUser.id,
                         data,
                        updated_at: now
                    }, {
                        onConflict: 'user_id'
                    });
                if (error) throw error;
                localStorage.setItem('smokingApp_lastUpdate', now);
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                return false;
            }
        }
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
            function showSyncIndicator(status, message) {
                // 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –≤ –ø–∞–Ω–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—ç–º–æ–¥–∑–∏)
                if (syncStatusIndicator) {
                    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –≤—ã–∑–æ–≤–µ
                    syncStatusIndicator.style.display = 'block';
                    switch (status) {
                        case 'syncing':
                            syncStatusIndicator.textContent = 'üü°'; // –ñ–µ–ª—Ç—ã–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                            syncStatusIndicator.style.animation = 'spin 1s linear infinite';
                            break;
                        case 'success':
                            syncStatusIndicator.textContent = 'üü¢'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —É—Å–ø–µ—Ö–∞
                            syncStatusIndicator.style.animation = 'none'; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                            break;
                        case 'error':
                            syncStatusIndicator.textContent = 'üî¥'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—à–∏–±–∫–∏
                            syncStatusIndicator.style.animation = 'none'; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                            break;
                        default:
                            syncStatusIndicator.textContent = '‚ö™'; // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                            syncStatusIndicator.style.animation = 'none';
                    }
                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Ä—è–¥–æ–º —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞ (syncStatusText)
                    if (syncStatusText) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                        syncStatusText.textContent = message;
                        // –î–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç –≤–∏–¥–∏–º—ã–º
                        syncStatusText.style.display = 'block';
                        // –î–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ success/error —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
                        if (status === 'success' || status === 'error') {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –∏—Å—á–µ–∑ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã (3000 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥)
                            setTimeout(() => {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–∞ —Å–ª—É—á–∞–π,
                                // –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∞ –∑–∞ —ç—Ç–∏ 3 —Å–µ–∫—É–Ω–¥—ã
                                if (syncStatusText) {
                                    // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
                                    syncStatusText.style.display = 'none';
                                }
                                // –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∞–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–æ–∂–µ —Å–∫—Ä—ã–≤–∞–ª—Å—è
                                // –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞/–æ—à–∏–±–∫–∏, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏:
                                // if (syncStatusIndicator) {
                                //     syncStatusIndicator.style.display = 'none';
                                // }
                            }, 3000); // –¢–µ–∫—Å—Ç –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω 3 —Å–µ–∫—É–Ω–¥—ã
                        }
                        // –î–ª—è —Å—Ç–∞—Ç—É—Å–∞ 'syncing' —Ç–µ–∫—Å—Ç –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º –¥–æ —Ç–µ—Ö –ø–æ—Ä,
                        // –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω showSyncIndicator —Å –¥—Ä—É–≥–∏–º —Å—Ç–∞—Ç—É—Å–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'success')
                    }
                }
            }
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function saveData() {
            try {
                localStorage.setItem('smokingData', JSON.stringify(data));
                // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ
                setTimeout(() => {
                    saveUserData();
                }, 100);
            } catch (e) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
            }
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadData() {
            try {
                const saved = localStorage.getItem('smokingData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç, –æ–±—ä–µ–¥–∏–Ω—è—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    const newData = { ...data, ...parsed };
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ timeStats –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (parsed && Array.isArray(parsed.timeStats)) {
                        // –ï—Å–ª–∏ timeStats –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                        newData.timeStats = parsed.timeStats;
                    } else {
                        // –ï—Å–ª–∏ timeStats –Ω–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
                        newData.timeStats = data.timeStats;
                    }
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ firstUseDate –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (parsed && parsed.firstUseDate) {
                        // –ï—Å–ª–∏ firstUseDate –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                        newData.firstUseDate = parsed.firstUseDate;
                    } else {
                        // –ï—Å–ª–∏ firstUseDate –Ω–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –¥–∞—Ç—É
                        newData.firstUseDate = data.firstUseDate;
                    }
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ achievements –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (parsed && Array.isArray(parsed.achievements)) {
                        // –ï—Å–ª–∏ achievements –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                        newData.achievements = parsed.achievements;
                    } else {
                        // –ï—Å–ª–∏ achievements –Ω–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
                        newData.achievements = data.achievements;
                    }
                    data = newData;
                }
            } catch (e) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
            }
        }
        // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–´–ß–ò–°–õ–ï–ù–ò–Ø –ü–û –ü–ï–†–ò–û–î–ê–ú ---
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–≥–∞—Ä–µ—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ X –¥–Ω–µ–π
        function calculateLastXPeriod(days) {
            if (data.timeStats.length === 0) {
                return 0;
            }
            const now = new Date();
            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ X –¥–Ω–µ–π –Ω–∞–∑–∞–¥ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
            const xDaysAgo = new Date(now);
            xDaysAgo.setDate(xDaysAgo.getDate() - days);
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            xDaysAgo.setHours(0, 0, 0, 0);
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –ø–æ–∑–∂–µ xDaysAgo
            const filteredStats = data.timeStats.filter(stat => {
                const statDate = new Date(stat.timestamp);
                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞—Ç—ã (statDate >= xDaysAgo)
                return statDate >= xDaysAgo;
            });
            return filteredStats.length;
        }
        // --- –ö–û–ù–ï–¶ –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô ---
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            // --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê ---
            // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –∏ 30 –¥–Ω–µ–π –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            data.week = calculateLastXPeriod(7);
            data.month = calculateLastXPeriod(30);
            // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---
            counterEl.textContent = data.today;
            weekEl.textContent = data.week; // –¢–µ–ø–µ—Ä—å —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            monthEl.textContent = data.month; // –¢–µ–ø–µ—Ä—å —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            goalEl.textContent = data.goal;
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            // const percent = Math.min(100, Math.round((data.today / data.goal) * 100));
            // goalPercentEl.textContent = `${percent}%`;
            // progressFillEl.style.width = `${percent}%`;
            // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô –î–õ–Ø –ü–†–û–ì–†–ï–°–°-–ë–ê–†–ê ---
            const percent = Math.round((data.today / data.goal) * 100);
            const clampedPercent = Math.min(100, percent); // –î–ª—è —à–∏—Ä–∏–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 100%
            goalPercentEl.textContent = `${percent}%`;
            // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞
            let progressBarColor;
            if (percent <= 50) {
                // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É –∑–µ–ª–µ–Ω—ã–º –∏ –∂–µ–ª—Ç—ã–º
                const ratio = percent / 50; // 0..1
                const r = Math.round(76 + (255 - 76) * ratio); // 76 (G) -> 255 (R –≤ Yellow)
                const g = Math.round(175 + (238 - 175) * ratio); // 175 (G) -> 238 (G –≤ Yellow)
                const b = Math.round(80 + (0 - 80) * ratio);   // 80 (B) -> 0
                progressBarColor = `rgb(${r}, ${g}, ${b})`;
            } else if (percent <= 100) {
                // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É –∂–µ–ª—Ç—ã–º –∏ –∫—Ä–∞—Å–Ω—ã–º
                const ratio = (percent - 50) / 50; // 0..1
                const r = 255; // R –æ—Å—Ç–∞–µ—Ç—Å—è 255
                const g = Math.round(238 - (238 - 60) * ratio); // 238 (G –≤ Yellow) -> 60 (G –≤ Red)
                const b = 0; // B –æ—Å—Ç–∞–µ—Ç—Å—è 0
                progressBarColor = `rgb(${r}, ${g}, ${b})`;
            } else {
                // –ë–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π –∏–ª–∏ –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç
                progressBarColor = '#D32F2F'; // –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
                // –î–æ–±–∞–≤–∏–º –ø—É–ª—å—Å–∞—Ü–∏—é –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
                // progressFillEl.style.animation = 'pulseDanger 0.5s infinite alternate';
            }
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∏ —à–∏—Ä–∏–Ω—É
            progressFillEl.style.width = `${clampedPercent}%`;
            progressFillEl.style.background = progressBarColor;
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é, –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç <= 100
            if (percent <= 100) {
                progressFillEl.style.animation = '';
            }
            // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ —ç–º–æ–¥–∑–∏
            const progressHeaderEl = document.querySelector('.progress-header h3'); // –ù–∞–π–¥–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            let progressMessage = "–ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–∫–∞–∑–∞ –æ—Ç –∫—É—Ä–µ–Ω–∏—è";
            let emoji = "";
            let isShake = false; // –§–ª–∞–≥ –¥–ª—è —Ç—Ä—è—Å–∫–∏
            if (data.today === 0) {
                progressMessage = "–ù–∞—á–Ω–∏ —Å–≤–æ–π –¥–µ–Ω—å —á–∏—Å—Ç—ã–º!";
                emoji = "üòä";
            } else if (percent < 30) {
                // –†–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è 1-29%
                const lowMessages = [
                    {msg: "–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ!", emoji: "üôÇ"},
                    {msg: "–¢—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏!", emoji: "üëç"},
                    {msg: "–ú–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!", emoji: "üåü"}
                ];
                const randomMsg = lowMessages[Math.floor(Math.random() * lowMessages.length)];
                progressMessage = randomMsg.msg;
                emoji = randomMsg.emoji;
            } else if (percent < 50) {
                emoji = "üôÇ";
            } else if (percent < 75) {
                // –†–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è 50-74%
                const midMessages = [
                    {msg: "–í—ã –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç–µ—Å—å –∫ –ª–∏–º–∏—Ç—É!", emoji: "üòê"},
                    {msg: "–ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è!", emoji: "üòê"},
                    {msg: "–í–Ω–∏–º–∞–Ω–∏–µ: –õ–∏–º–∏—Ç –±–ª–∏–∑–∫–æ!", emoji: "‚ö†Ô∏è"}
                ];
                const randomMsg = midMessages[Math.floor(Math.random() * midMessages.length)];
                progressMessage = randomMsg.msg;
                emoji = randomMsg.emoji;
            } else if (percent < 100) {
                progressMessage = "–õ–∏–º–∏—Ç –ø–æ—á—Ç–∏ –∏—Å—á–µ—Ä–ø–∞–Ω!";
                emoji = "üò®";
            } else if (percent === 100) {
                // –†–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è 100%
                const limitMessages = [
                    {msg: "–õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω!", emoji: "‚ö†Ô∏è"},
                    {msg: "–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞. –û—Å—Ç–æ—Ä–æ–∂–Ω–æ!", emoji: "‚ö†Ô∏è"},
                    {msg: "–ü—Ä–µ–¥–µ–ª –¥–Ω–µ–≤–Ω–æ–π –Ω–æ—Ä–º—ã!", emoji: "‚õî"}
                ];
                const randomMsg = limitMessages[Math.floor(Math.random() * limitMessages.length)];
                progressMessage = randomMsg.msg;
                emoji = randomMsg.emoji;
            } else { // percent > 100
                // –†–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è >100%
                const overMessages = [
                    {msg: "–õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω! –ü–æ–¥—É–º–∞–π –æ –∑–¥–æ—Ä–æ–≤—å–µ!", emoji: "üö®"},
                    {msg: "–ü–µ—Ä–µ–±–æ—Ä! –û–¥—É–º–∞–π—Å—è!", emoji: "üò±"},
                    {msg: "–≠—Ç–æ —É–∂–µ –≤—Ä–µ–¥! –•–≤–∞—Ç–∏—Ç!", emoji: "üòµ‚Äçüí´"},
                    {msg: "–°—Ç–æ–ø! –ü–æ–¥—É–º–∞–π –æ —Å–≤–æ–µ–º –∑–¥–æ—Ä–æ–≤—å–µ!", emoji: "üõë"}
                ];
                const randomMsg = overMessages[Math.floor(Math.random() * overMessages.length)];
                progressMessage = randomMsg.msg;
                emoji = randomMsg.emoji;
                isShake = true; // –í–∫–ª—é—á–∞–µ–º —Ç—Ä—è—Å–∫—É
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞
            progressHeaderEl.textContent = `${emoji} ${progressMessage}`;
            // 3. –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ —Ñ–æ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const progressContainer = document.querySelector('.progress-container');
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
            progressFillEl.style.animation = '';
            progressContainer.style.animation = '';
            if (percent >= 110) { // –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ —Å 110%
                // –ü—É–ª—å—Å–∞—Ü–∏—è –ø–æ–ª–æ—Å—ã
                progressFillEl.style.animation = 'pulseDanger 0.5s infinite';
                // –¢—Ä—è—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 3 —Ä–∞–∑–∞
                progressContainer.style.animation = 'shake 0.2s 3';
            }
            // 4. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–º–µ—à–∏–≤–∞–Ω–∏—è (0..1) –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π > 100%
            let mixRatio = 0;
            if (percent > 100) {
                 mixRatio = Math.min(1, (percent - 100) / 100); // –ü—Ä–∏–º–µ—Ä: 110% -> 0.1, 200% -> 1
            }
            // –ò–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ–º –º–µ–∂–¥—É –Ω–∞—á–∞–ª—å–Ω—ã–º –∏ –∫–æ–Ω–µ—á–Ω—ã–º —Ü–≤–µ—Ç–æ–º —Ñ–æ–Ω–∞
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±—É–¥–µ–º –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª –∫—Ä–∞—Å–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            // –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç: rgba(255, 255, 255, 0.1) –∏–ª–∏ rgba(0, 0, 0, 0.1) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
            // –ö–æ–Ω–µ—á–Ω—ã–π —Ü–≤–µ—Ç: rgba(255, 100, 100, 0.2)
            // –ú—ã –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –∫—Ä–∞—Å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∞–ª—å—Ñ–∞
            const startAlpha = 0.1; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            const endAlpha = 0.2;
            const currentAlpha = startAlpha + (endAlpha - startAlpha) * mixRatio;
            const startRed = 255; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            const endRed = 255;
            const currentRed = Math.round(startRed + (endRed - startRed) * mixRatio);
            const bgColor = `rgba(${currentRed}, 100, 100, ${currentAlpha})`;
            progressContainer.style.background = bgColor;
            // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô –î–õ–Ø –ü–†–û–ì–†–ï–°–°-–ë–ê–†–ê ---
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–û - —Å—á–∏—Ç–∞–µ–º –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è)
            const costPerCigarette = data.packPrice / data.cigarettesPerPack;
            const totalCost = data.totalCost; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            costsEl.textContent = `${Math.round(totalCost)} ‚ÇΩ`;
            packPriceEl.textContent = data.packPrice;
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
            const startDate = new Date(data.firstUseDate);
            const startDateStr = startDate.toLocaleDateString('ru-RU');
            const costsContainer = document.querySelector('.costs-container');
            let startDateEl = costsContainer.querySelector('.start-date');
            if (!startDateEl) {
                startDateEl = document.createElement('p');
                startDateEl.className = 'start-date';
                startDateEl.style.fontSize = '0.8rem';
                startDateEl.style.opacity = '0.8';
                startDateEl.style.marginTop = '5px';
                costsContainer.appendChild(startDateEl);
            }
            startDateEl.textContent = `–° ${startDateStr}`;
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
            const achievedCount = data.achievements.filter(a => a.achieved).length;
            achievementsCountEl.textContent = `${achievedCount}/${data.achievements.length}`;
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã
            if (data.lastCigaretteTime) {
                const lastTime = new Date(data.lastCigaretteTime);
                lastCigaretteTimeEl.textContent = lastTime.toLocaleTimeString('ru-RU');
            } else {
                lastCigaretteTimeEl.textContent = '--:--:--';
            }
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è "–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è"  // <-- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê
            const allTimeValueEl = document.getElementById('allTimeValue');
            const firstUseDateLabelEl = document.getElementById('firstUseDateLabel');
            if (allTimeValueEl) {
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç
                const allTimeCount = data.timeStats.length;
                allTimeValueEl.textContent = allTimeCount;
            }
            if (firstUseDateLabelEl) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞—Ç—É –ø–µ—Ä–≤–æ–π —Å–∏–≥–∞—Ä–µ—Ç—ã
                if (data.timeStats.length > 0) {
                    // –ë–µ—Ä–µ–º —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –∑–∞–ø–∏—Å—å
                    const earliestStat = data.timeStats.reduce((earliest, current) =>
                        (current.timestamp < earliest.timestamp) ? current : earliest
                    );
                    const firstDate = new Date(earliestStat.timestamp);
                    firstUseDateLabelEl.textContent = `—Å ${firstDate.toLocaleDateString('ru-RU')}`;
                } else if (data.firstUseDate) {
                    // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç, –Ω–æ –¥–∞—Ç–∞ –ø–µ—Ä–≤–æ–π —Å–∏–≥–∞—Ä–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
                    const firstDate = new Date(data.firstUseDate);
                    firstUseDateLabelEl.textContent = `—Å ${firstDate.toLocaleDateString('ru-RU')}`;
                } else {
                    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
                    firstUseDateLabelEl.textContent = '–¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç';
                }
            }
        }
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ —Ñ–∞–∫—Ç–∞ –ø–æ —á–∞—Å–∞–º
        function showMedicalFact() {
            const factContainer = document.getElementById('medical-fact');
            if (!factContainer) return;
            if (data.lastCigaretteTime) {
                const now = new Date();
                const lastTime = new Date(data.lastCigaretteTime);
                const diffHours = Math.floor((now - lastTime) / (1000 * 60 * 60));
            if (diffHours >= 1 && diffHours <= 24) {
                factContainer.textContent = medicalFacts[diffHours - 1];
                factContainer.style.display = 'block';
            } else if (diffHours > 24) {
                factContainer.textContent = "–ë–æ–ª–µ–µ 24 —á–∞—Å–æ–≤ –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç! –û—Ä–≥–∞–Ω–∏–∑–º –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è!";
                factContainer.style.display = 'block';
            } else {
                factContainer.style.display = 'none';
            }
            } else {
            factContainer.style.display = 'none';
            }
        }
        // –¢–∞–π–º–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã
        function startTimer() {
            setInterval(() => {
            if (data.lastCigaretteTime) {
                const now = new Date();
                const lastTime = new Date(data.lastCigaretteTime);
                const diff = now - lastTime;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                timerEl.textContent =
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                timerEl.textContent = '00:00:00';
            }
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ —Ñ–∞–∫—Ç–∞
            showMedicalFact();
        }, 1000);
        }
        // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
        function incrementCounter() {
            data.today++;
            // data.week –∏ data.month —Ç–µ–ø–µ—Ä—å –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏—Ö –∑–¥–µ—Å—å
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–∏–≥–∞—Ä–µ—Ç—ã
            const now = new Date();
            data.timeStats.push({
                time: now.toLocaleTimeString('ru-RU'),
                timestamp: now.getTime(),
                date: now.toDateString()
            });
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã
            data.lastCigaretteTime = now.getTime();
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
            const costPerCigarette = data.packPrice / data.cigarettesPerPack;
            data.totalCost += costPerCigarette;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–∏–∏ –¥–Ω–µ–π –±–µ–∑ –∫—É—Ä–µ–Ω–∏—è
            const today = new Date().toDateString();
            if (data.lastDate !== today) {
                data.lastDate = today;
                data.usageDays++;
            }
            saveData();
            updateUI();
            checkAchievements();
            renderAchievements();
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥—ã–º–∞
            createSmokeAnimation();
        }
        // –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
        function decrementCounter() {
            if (data.today > 0) {
                data.today--;
                // data.week –∏ data.month —Ç–µ–ø–µ—Ä—å –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º –∏—Ö –∑–¥–µ—Å—å
                // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–∏–≥–∞—Ä–µ—Ç—É –∏–∑ –≤—Ä–µ–º–µ–Ω–∏
                if (data.timeStats.length > 0) {
                    data.timeStats.pop();
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã
                    if (data.timeStats.length > 0) {
                        data.lastCigaretteTime = data.timeStats[data.timeStats.length - 1].timestamp;
                    } else {
                        data.lastCigaretteTime = null;
                    }
                } else {
                    data.lastCigaretteTime = null;
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
                const costPerCigarette = data.packPrice / data.cigarettesPerPack;
                data.totalCost -= costPerCigarette;
                data.totalCost = Math.max(0, data.totalCost);
                saveData();
                updateUI(); // updateUI –≤—ã–∑–æ–≤–µ—Ç calculateLastXPeriod, –æ–±–Ω–æ–≤–∏–≤ week –∏ month
                checkAchievements();
                renderAchievements();
                // –ê–Ω–∏–º–∞—Ü–∏—è –¥—ã–º–∞
                createSmokeAnimation();
            }
        }
        // –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥—ã–º–∞
        function createSmokeAnimation() {
            counterEl.classList.add('pulse');
            setTimeout(() => {
                counterEl.classList.remove('pulse');
            }, 400); // –£–º–µ–Ω—å—à–µ–Ω–æ
        }
        // –°–±—Ä–æ—Å –≤—Å–µ–≥–æ
        function resetAll() {
            const confirmed1 = confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');
            if (confirmed1) {
                const confirmed2 = confirm('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –í–°–ï –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
                if (confirmed2) {
                    // –°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                    data = {
                        today: 0,
                        week: 0,
                        month: 0,
                        goal: 20,
                        packPrice: 250,
                        cigarettesPerPack: 20,
                        streak: 0,
                        lastDate: null,
                        timeStats: [],
                        lastAutoResetDate: new Date().toDateString(), // –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞
                        achievements: [
                            { id: 1, name: "–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å", description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å", target: 1, achieved: false, icon: "üìÖ" },
                            { id: 2, name: "–ù–µ–¥–µ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—é", target: 7, achieved: false, icon: "üóìÔ∏è" },
                            { id: 3, name: "–ú–µ—Å—è—Ü –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–µ—Å—è—Ü", target: 30, achieved: false, icon: "üìÜ" },
                            { id: 4, name: "100 —Å–∏–≥–∞—Ä–µ—Ç", description: "–í—ã–∫—É—Ä–∏—Ç—å 100 —Å–∏–≥–∞—Ä–µ—Ç", target: 100, achieved: false, icon: "üö¨" },
                            { id: 5, name: "–≠–∫–æ–Ω–æ–º–∏—è –∑–¥–æ—Ä–æ–≤—å—è", description: "–°–æ–∫—Ä–∞—Ç–∏—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –Ω–∞ 50% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –Ω–µ–¥–µ–ª–µ–π", target: 50, achieved: false, icon: "üíö" }
                        ],
                        totalCost: 0,
                        usageDays: 0,
                        firstUseDate: new Date().toDateString(),
                        lastCigaretteTime: null
                    };
                    saveData();
                    updateUI();
                    renderAchievements();
                    // –ê–Ω–∏–º–∞—Ü–∏—è —Å–±—Ä–æ—Å–∞
                    document.body.style.backgroundColor = '#FF5252';
                    setTimeout(() => {
                        document.body.style.backgroundColor = '';
                    }, 400); // –£–º–µ–Ω—å—à–µ–Ω–æ
                }
            }
        }
        // –†—É—á–Ω–æ–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–ò–°–ü–†–ê–í–õ–ï–ù–ê)
        function manualResetToday() {
            const confirmed = confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è? –°—á–µ—Ç—á–∏–∫ "–°–µ–≥–æ–¥–Ω—è" –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 0.');
            if (confirmed) {
                console.log("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä—É—á–Ω–æ–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ '–°–µ–≥–æ–¥–Ω—è'...");
                // 1. –ü—Ä–æ—Å—Ç–æ –æ–±–Ω—É–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
                data.today = 0;
                // 2. –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º data.lastCigaretteTime! –û—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å.
                //    –û–Ω –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–π —Å–∏–≥–∞—Ä–µ—Ç—ã.
                console.log("–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã –æ—Å—Ç–∞–ª–æ—Å—å –ø—Ä–µ–∂–Ω–∏–º:", data.lastCigaretteTime ? new Date(data.lastCigaretteTime).toLocaleString('ru-RU') : 'null');
                // 3. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä—É—á–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞/–∞–≤—Ç–æ—Å–±—Ä–æ—Å–∞
                data.lastAutoResetDate = new Date().toDateString();
                console.log("–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞:", data.lastAutoResetDate);
                // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                saveData();
                updateUI();
                console.log("–†—É—á–Ω–æ–π —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ '–°–µ–≥–æ–¥–Ω—è' –∑–∞–≤–µ—Ä—à–µ–Ω.");
                // –ê–Ω–∏–º–∞—Ü–∏—è —Å–±—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                counterEl.style.color = '#FF5252';
                setTimeout(() => {
                    counterEl.style.color = '';
                }, 500);
            }
        }
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function openSettings() {
            document.getElementById('goalSetting').value = data.goal;
            document.getElementById('priceSetting').value = data.packPrice;
            document.getElementById('countSetting').value = data.cigarettesPerPack;
            settingsModal.style.display = 'flex';
        }
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function closeSettings() {
            settingsModal.style.display = 'none';
        }
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function saveSettings() {
            data.goal = parseInt(document.getElementById('goalSetting').value) || 20;
            data.packPrice = parseInt(document.getElementById('priceSetting').value) || 250;
            data.cigarettesPerPack = parseInt(document.getElementById('countSetting').value) || 20;
            saveData();
            updateUI();
            closeSettings();
        }
        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'smoking-data.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function refreshApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.update();
                    }
                });
            }
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
            if (window.caches) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            location.reload(true);
        }
        // –ü–æ–∫–∞–∑ —Å–ª—É—á–∞–π–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã
        function showRandomQuote() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            quoteEl.textContent = `"${quotes[randomIndex]}"`;
        }
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        function checkAchievements() {
            data.achievements.forEach(achievement => {
                if (!achievement.achieved) {
                    let achieved = false;
                    switch(achievement.id) {
                        case 1: // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å
                            achieved = data.usageDays >= achievement.target;
                            break;
                        case 2: // –ù–µ–¥–µ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                            achieved = data.usageDays >= achievement.target;
                            break;
                        case 3: // –ú–µ—Å—è—Ü –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                            achieved = data.usageDays >= achievement.target;
                            break;
                        case 4: // 100 —Å–∏–≥–∞—Ä–µ—Ç
                            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
                            achieved = data.timeStats.length >= achievement.target;
                            break;
                        case 5: // –≠–∫–æ–Ω–æ–º–∏—è –∑–¥–æ—Ä–æ–≤—å—è (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 50% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –Ω–µ–¥–µ–ª–µ–π)
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é
                            // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å lastWeekStats –∏ averageCigarettesPerDay
                            // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
                            // –ü—Ä–∏–º–µ—Ä —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ (–µ—Å–ª–∏ data.week > 0 –∏ —Å–µ–≥–æ–¥–Ω—è –Ω–∞ 50% –º–µ–Ω—å—à–µ):
                            if (data.week > 0) {
                                const averageLastWeek = data.week / 7;
                                if (averageLastWeek > 0) {
                                    const reduction = ((averageLastWeek - data.today) / averageLastWeek) * 100;
                                    achieved = reduction >= achievement.target;
                                    console.log(`–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ "–≠–∫–æ–Ω–æ–º–∏—è –∑–¥–æ—Ä–æ–≤—å—è": –°—Ä–µ–¥–Ω–µ–µ –∑–∞ –Ω–µ–¥–µ–ª—é: ${averageLastWeek.toFixed(2)}, –°–µ–≥–æ–¥–Ω—è: ${data.today}, –°–Ω–∏–∂–µ–Ω–∏–µ: ${reduction.toFixed(2)}%`);
                                }
                            }
                            break;
                    }
                    if (achieved) {
                        achievement.achieved = true;
                        showAchievementNotification(achievement);
                    }
                }
            });
        }
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏
        function showAchievementNotification(achievement) {
            alert(`üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${achievement.name}
${achievement.description}`);
        }
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        function renderAchievements() {
            achievementsListEl.innerHTML = '';
            data.achievements.forEach(achievement => {
                const achievementEl = document.createElement('div');
                achievementEl.className = `achievement ${achievement.achieved ? 'achieved' : ''}`;
                achievementEl.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${achievement.description}</div>
                    </div>
                `;
                achievementsListEl.appendChild(achievementEl);
            });
        }
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –≤—Ä–µ–º–µ–Ω–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–ê)
        function toggleTimeDetails(period) {
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ card
            let card;
            if (period === 'all') {
                card = document.getElementById('allTimeCard');
            } else {
                card = document.getElementById(`${period}Card`);
            }
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç card
            if (!card) {
                console.error(`Card element for period '${period}' not found.`);
                return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
            }
            const existingDetails = card.querySelector('.time-details');
            if (existingDetails) {
                existingDetails.remove();
            } else {
                if (data.timeStats.length > 0) {
                    const details = document.createElement('div');
                    details.className = 'time-details';
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–µ—Ä–∏–æ–¥—É
                    let filteredStats = [];
                    const now = new Date();
                    // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
                    if (period === 'today') {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ "–Ω–∞—à–µ–≥–æ –¥–Ω—è" (—Å–µ–≥–æ–¥–Ω—è –≤ 06:00)
                        const startOfTodayPeriod = new Date(now);
                        startOfTodayPeriod.setHours(6, 0, 0, 0); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 06:00:00.000
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—Ü "–Ω–∞—à–µ–≥–æ –¥–Ω—è" (–∑–∞–≤—Ç—Ä–∞ –≤ 05:59:59.999)
                        const endOfTodayPeriod = new Date(startOfTodayPeriod);
                        endOfTodayPeriod.setDate(endOfTodayPeriod.getDate() + 1); // –ü—Ä–∏–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –¥–µ–Ω—å
                        endOfTodayPeriod.setMilliseconds(endOfTodayPeriod.getMilliseconds() - 1); // –í—ã—á–∏—Ç–∞–µ–º 1 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å 05:59:59.999
                        filteredStats = data.timeStats.filter(stat => {
                            const statTimestamp = stat.timestamp; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ —á–∏—Å–ª–æ - –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
                            return statTimestamp >= startOfTodayPeriod.getTime() && statTimestamp <= endOfTodayPeriod.getTime();
                        });
                    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
                    } else if (period === 'week') {
                        // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        weekAgo.setHours(0, 0, 0, 0); // –ù–∞—á–∞–ª–æ 7-–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
                        filteredStats = data.timeStats.filter(record => {
                            const recordDate = new Date(record.timestamp);
                            return recordDate >= weekAgo;
                        });
                    } else if (period === 'month') {
                        // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π
                        const monthAgo = new Date();
                        monthAgo.setDate(monthAgo.getDate() - 30);
                        monthAgo.setHours(0, 0, 0, 0); // –ù–∞—á–∞–ª–æ 30-–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
                        filteredStats = data.timeStats.filter(record => {
                            const recordDate = new Date(record.timestamp);
                            return recordDate >= monthAgo;
                        });
                    } else if (period === 'all') {
                        filteredStats = [...data.timeStats];
                    }
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    const sortedStats = [...filteredStats].sort((a, b) => b.timestamp - a.timestamp);
                    if (sortedStats.length > 0) {
                        sortedStats.forEach(stat => {
                            const timeItem = document.createElement('div');
                            timeItem.className = 'time-item';
                            const recordDate = new Date(stat.timestamp);
                            timeItem.textContent = `${recordDate.toLocaleTimeString('ru-RU')} - ${recordDate.toLocaleDateString('ru-RU')}`;
                            details.appendChild(timeItem);
                        });
                    } else {
                        const timeItem = document.createElement('div');
                            timeItem.className = 'time-item';
                            timeItem.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                            details.appendChild(timeItem);
                    }
                    card.appendChild(details);
                }
            }
        }
        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ì–†–ê–§–ò–ö–û–í –° CHART.JS ---
        let statsChartInstance = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function renderStatsChart(chartType) {
            const canvas = document.getElementById('statsChart');
            if (!canvas) {
                console.error("Canvas —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω");
                return;
            }

            const ctx = canvas.getContext('2d');

            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä –≥—Ä–∞—Ñ–∏–∫–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (statsChartInstance) {
                statsChartInstance.destroy();
            }

            let chartData = {};
            let chartOptions = {};

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ–ø—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
            switch (chartType) {
                case 'weekday':
                    chartData = getWeekdayChartData();
                    chartOptions = getWeekdayChartOptions();
                    xAxisLabel.textContent = '–î–Ω–∏ –Ω–µ–¥–µ–ª–∏';
                    yAxisLabel.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç';
                    break;
                case 'daily':
                    chartData = getDailyChartData();
                    chartOptions = getDailyChartOptions();
                    xAxisLabel.textContent = '–î–∞—Ç–∞';
                    yAxisLabel.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç';
                    break;
                case 'hourly':
                    chartData = getHourlyChartData();
                    chartOptions = getHourlyChartOptions();
                    xAxisLabel.textContent = '–ß–∞—Å—ã';
                    yAxisLabel.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç';
                    break;
                case 'savings':
                    chartData = getSavingsChartData();
                    chartOptions = getSavingsChartOptions();
                    xAxisLabel.textContent = '–î–∞—Ç–∞';
                    yAxisLabel.textContent = '–≠–∫–æ–Ω–æ–º–∏—è (‚ÇΩ)';
                    break;
                default:
                    return; // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ —Å –ø–æ–º–æ—â—å—é Chart.js
            statsChartInstance = new Chart(ctx, {
                type: 'bar', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
                data: chartData,
                options: chartOptions
            });
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –æ–ø—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ ---

        // 1. –ì—Ä–∞—Ñ–∏–∫ "–ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏"
        function getWeekdayChartData() {
            const weekdayStats = new Array(7).fill(0);
            const weekdayLabels = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];

            if (data.timeStats.length > 0) {
                data.timeStats.forEach(stat => {
                    const statDate = new Date(stat.timestamp);
                    const weekday = statDate.getDay(); // 0 (–í—Å) - 6 (–°–±)
                    weekdayStats[weekday]++;
                });
            }

            return {
                labels: weekdayLabels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç',
                    data: weekdayStats,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)', // –í—Å
                        'rgba(54, 162, 235, 0.7)',  // –ü–Ω
                        'rgba(255, 206, 86, 0.7)',  // –í—Ç
                        'rgba(75, 192, 192, 0.7)',  // –°—Ä
                        'rgba(153, 102, 255, 0.7)', // –ß—Ç
                        'rgba(255, 159, 64, 0.7)',  // –ü—Ç
                        'rgba(199, 199, 199, 0.7)'  // –°–±
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(199, 199, 199, 1)'
                    ],
                    borderWidth: 1
                }]
            };
        }

        function getWeekdayChartOptions() {
            return getDefaultBarChartOptions();
        }

        // 2. –ì—Ä–∞—Ñ–∏–∫ "–ü–æ –¥–Ω—è–º" (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
        function getDailyChartData() {
             const now = new Date();
            const dates = [];
            const counts = [];
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π (–≤–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è)
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                dates.push(date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
                
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∏–≥–∞—Ä–µ—Ç—ã –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
                const dayStart = new Date(date);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(dayStart);
                dayEnd.setDate(dayEnd.getDate() + 1);
                
                const count = data.timeStats.filter(stat => {
                    const statDate = new Date(stat.timestamp);
                    return statDate >= dayStart && statDate < dayEnd;
                }).length;
                
                counts.push(count);
            }

            return {
                labels: dates,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç',
                    data: counts,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            };
        }

        function getDailyChartOptions() {
            return getDefaultBarChartOptions();
        }

        // 3. –ì—Ä–∞—Ñ–∏–∫ "–ü–æ —á–∞—Å–∞–º —Å—É—Ç–æ–∫"
        function getHourlyChartData() {
            const hourlyStats = new Array(24).fill(0);
            const hourLabels = Array.from({length: 24}, (_, i) => `${i}:00`);

            if (data.timeStats.length > 0) {
                data.timeStats.forEach(stat => {
                    const statDate = new Date(stat.timestamp);
                    const hour = statDate.getHours();
                    hourlyStats[hour]++;
                });
            }

            return {
                labels: hourLabels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–∞—Ä–µ—Ç',
                    data: hourlyStats,
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            };
        }

        function getHourlyChartOptions() {
            return {
                ...getDefaultBarChartOptions(),
                scales: {
                    ...getDefaultBarChartOptions().scales,
                    x: {
                        ...getDefaultBarChartOptions().scales.x,
                        ticks: {
                            ...getDefaultBarChartOptions().scales.x.ticks,
                            // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
                            autoSkip: false,
                            maxRotation: 90,
                            minRotation: 90,
                            font: {
                                size: 9
                            }
                        }
                    }
                }
            };
        }

        // 4. –ì—Ä–∞—Ñ–∏–∫ "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è"
        function getSavingsChartData() {
            const now = new Date();
            const dates = [];
            const savings = [];
            let cumulativeSavings = 0;
            const costPerCigarette = data.packPrice / data.cigarettesPerPack;

            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 30 –¥–Ω–µ–π
            const dailyData = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è {–¥–∞—Ç–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ}
            for (let i = 29; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = date.toDateString();
                dailyData[dateStr] = 0; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω—É–ª–µ–º
                dates.push(date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
            }

            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∏–≥–∞—Ä–µ—Ç—ã –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
            data.timeStats.forEach(stat => {
                const statDate = new Date(stat.timestamp);
                const statDateStr = statDate.toDateString();
                if (dailyData.hasOwnProperty(statDateStr)) {
                    dailyData[statDateStr]++;
                }
            });

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é
            Object.entries(dailyData).forEach(([dateStr, count], index) => {
                // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ —Ü–µ–ª—å - data.goal —Å–∏–≥–∞—Ä–µ—Ç –≤ –¥–µ–Ω—å
                const potentialCigarettes = data.goal;
                const savedCigarettes = Math.max(0, potentialCigarettes - count);
                cumulativeSavings += savedCigarettes * costPerCigarette;
                savings.push(parseFloat(cumulativeSavings.toFixed(2)));
            });

            return {
                labels: dates,
                datasets: [{
                    label: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è (‚ÇΩ)',
                    data: savings,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                    pointRadius: 3,
                    fill: true,
                    tension: 0.3 // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏
                }]
            };
        }

        function getSavingsChartOptions() {
            return {
                ...getDefaultBarChartOptions(),
                type: 'line', // –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
                scales: {
                    ...getDefaultBarChartOptions().scales,
                    y: {
                        ...getDefaultBarChartOptions().scales.y,
                        ticks: {
                            ...getDefaultBarChartOptions().scales.y.ticks,
                            callback: function(value) {
                                return value + ' ‚ÇΩ';
                            }
                        }
                    }
                },
                plugins: {
                    ...getDefaultBarChartOptions().plugins,
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y} ‚ÇΩ`;
                            }
                        }
                    }
                }
            };
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ–ø—Ü–∏–π —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
        function getDefaultBarChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `–°–∏–≥–∞—Ä–µ—Ç: ${context.parsed.y}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.9)'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            };
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function openStatsModal() {
            statsModal.style.display = 'flex';
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ "–î–Ω–∏ –Ω–µ–¥–µ–ª–∏"
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.chart-btn[data-chart="weekday"]').classList.add('active');
            renderStatsChart('weekday'); // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫ "–î–Ω–∏ –Ω–µ–¥–µ–ª–∏" –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        }
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function closeStatsModalFunc() {
            statsModal.style.display = 'none';
        }
        // --- –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ theme-color –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≥—Ä–∞–¥–∏–µ–Ω—Ç—É
        function updateThemeColor() {
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            if (metaThemeColor) {
                metaThemeColor.setAttribute('content', '#1a2a6c');
            }
        }
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è theme-color
        document.addEventListener('DOMContentLoaded', () => {
            updateThemeColor();
        });
    </script>
</body>
</html>
